name: ðŸŽ­ Playwright E2E & API Tests

on:
  push:
    branches: [ main, master, develop, feature/automatizacion-checkout ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ejecutar diariamente a las 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Permite ejecuciÃ³n manual desde GitHub UI

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Test - ${{ matrix.project }}
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        project: 
          - 'UI - Chromium'
          - 'UI - Firefox'
          - 'API Tests'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'

    - name: ðŸ”§ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: ðŸ§ª Run Playwright tests
      run: npx playwright test --project="${{ matrix.project }}"
      env:
        BASE_URL: ${{ secrets.BASE_URL || 'https://www.saucedemo.com/' }}
        SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME || 'standard_user' }}
        SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD || 'secret_sauce' }}
        API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://jsonplaceholder.typicode.com' }}
        CI: true

    - name: ðŸ“Š Upload Blob Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: blob-report-${{ matrix.project }}
        path: blob-report/
        retention-days: 1

    - name: ðŸ” Upload Test Traces
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-traces-${{ matrix.project }}
        path: test-results/
        retention-days: 7

    - name: ðŸ“¸ Upload Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots-${{ matrix.project }}
        path: test-results/**/*.png
        retention-days: 7
        if-no-files-found: ignore

    - name: ðŸŽ¥ Upload Videos
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: videos-${{ matrix.project }}
        path: test-results/**/*.webm
        retention-days: 7
        if-no-files-found: ignore

  # Job para combinar reportes
  merge-reports:
    name: ðŸ“¦ Merge Reports
    if: always()
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'

    - name: ðŸ”§ Install dependencies
      run: npm ci

    - name: ðŸ“¥ Download blob reports
      uses: actions/download-artifact@v4
      with:
        path: all-blob-reports/
        pattern: blob-report-*
        merge-multiple: true

    - name: ðŸ§¬ Merge reports
      run: npx playwright merge-reports --reporter=html ./all-blob-reports

    - name: ðŸ“Š Upload HTML Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: html-report--attempt-${{ github.run_attempt }}
        path: playwright-report/
        retention-days: 14

    - name: ðŸš€ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: playwright-report/

  # Job de despliegue a GitHub Pages
  deploy-report:
    name: ðŸš€ Deploy to GitHub Pages
    needs: merge-reports
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job de notificaciones
  notify:
    name: ðŸ”” Notify Results
    if: always()
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“Š Check test results
      id: test-results
      run: |
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "status=âœ… All tests passed!" >> $GITHUB_OUTPUT
        else
          echo "status=âŒ Some tests failed!" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ’¬ Summary
      run: |
        echo "### Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.test-results.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
